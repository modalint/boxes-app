<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מעקב קרטונים למעבר דירה</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; direction: rtl;
        }
        .container {
            max-width: 1200px; margin: 0 auto;
            background: white; border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: 
                linear-gradient(135deg, rgba(44, 62, 80, 0.8) 0%, rgba(52, 152, 219, 0.8) 100%),
                url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/4gKgSUNDX1BST0ZJTEUAAQEAAAKQbGNtcwQwAABtbnRyUkdCIFhZWiAH3wAIABMAEgAWADFhY3NwQVBQTAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAPbWAAEAAAAA0y1sY21zAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKZGVzYwAAAPwAAAA+Y3BydAAAATwAAAAuZG1uZAAAAWwAAAAwZG1kZAAAAZwAAAAoYmx1ZAAAAZQAAAAIDZ2VuAAOApAAAACgYmZjAAOBaAAAACFmYgAAAOBwAAAACGNocmOAAAOBaAAAACmbWxdYAAOBaAAAACRjR3nAAOBsAAAACGVpeWOAAAOBaAAAACRnUkdCAAOBaAAAASA==') center/cover no-repeat;
            color: white; 
            padding: 3rem 2rem; 
            text-align: center;
            background-blend-mode: overlay;
            position: relative;
            min-height: 280px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.2) 100%);
            pointer-events: none;
        }
        .header h1, .header p {
            position: relative;
            z-index: 2;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.7);
        }
        .header h1 { margin: 0; font-size: 2.5rem; }
        .header p { margin: 10px 0 0 0; opacity: 0.9; font-size: 1.1rem; }
        
        .status-bar {
            padding: 1rem 2rem; font-weight: bold; 
            border-bottom: 1px solid #eee; font-size: 0.9rem;
        }
        .status-connected { background: #d4edda; color: #155724; }
        .status-local { background: #fff3cd; color: #856404; }
        .status-error { background: #f8d7da; color: #721c24; }
        
        .main-content { padding: 2rem; }
        
        .google-setup {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white; padding: 2rem; margin-bottom: 2rem;
            border-radius: 10px; text-align: center;
        }
        .google-setup h3 { margin-top: 0; font-size: 1.5rem; }
        .google-setup input {
            width: 70%; padding: 12px; font-size: 16px;
            border: none; border-radius: 25px; margin: 10px;
            text-align: center;
        }
        .google-setup button {
            background: white; color: #4285f4;
            padding: 12px 30px; border: none; border-radius: 25px;
            font-weight: bold; cursor: pointer; font-size: 16px;
            transition: all 0.3s;
        }
        .google-setup button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .card {
            background: white; padding: 2rem; margin-bottom: 2rem;
            border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #3498db;
        }
        .card h3 { margin-top: 0; color: #2c3e50; font-size: 1.3rem; }
        
        .form-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem; margin-bottom: 2rem;
        }
        .form-group label {
            display: block; font-weight: bold; margin-bottom: 0.5rem;
            color: #2c3e50; font-size: 0.9rem;
        }
        .form-group input, .form-group select {
            width: 100%; padding: 12px; border: 2px solid #ddd;
            border-radius: 8px; font-size: 16px; transition: border 0.3s;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: #3498db; outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .btn {
            padding: 12px 24px; border: none; border-radius: 8px;
            cursor: pointer; font-size: 16px; font-weight: bold;
            transition: all 0.3s; text-decoration: none; display: inline-block;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem; margin-bottom: 2rem;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 2rem; border-radius: 10px; text-align: center;
        }
        .stat-number { font-size: 3rem; font-weight: bold; margin: 10px 0; }
        .stat-label { font-size: 1rem; opacity: 0.9; }
        
        .boxes-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem; margin-top: 2rem;
        }
        .box-card {
            background: white; border: 2px solid #ecf0f1; border-radius: 10px;
            padding: 1.5rem; transition: all 0.3s; position: relative;
            overflow: hidden;
        }
        .box-card:hover {
            transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-color: #3498db;
        }
        .box-number {
            font-size: 2.5rem; font-weight: bold; text-align: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 1rem; border-radius: 8px; margin-bottom: 1rem;
            color: #2c3e50;
        }
        .room-tag {
            display: inline-block; padding: 8px 16px; border-radius: 20px;
            font-size: 0.8rem; font-weight: bold; margin-bottom: 1rem;
            text-align: center; width: 100%;
        }
        .contents-box {
            background: #f8f9fa; padding: 1rem; border-radius: 8px;
            margin-bottom: 1rem; color: #2c3e50; min-height: 60px;
        }
        .timestamp {
            font-size: 0.75rem; color: #7f8c8d; text-align: center;
            margin-bottom: 1rem; font-style: italic;
        }
        .actions {
            display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;
        }
        
        .room-salon { background: #e3f2fd; color: #1976d2; }
        .room-kitchen { background: #e8f5e8; color: #388e3c; }
        .room-ariel { background: #f3e5f5; color: #7b1fa2; }
        .room-liri { background: #fce4ec; color: #c2185b; }
        .room-erez { background: #fff3e0; color: #f57c00; }
        .room-music { background: #e8eaf6; color: #3f51b5; }
        .room-vika { background: #ffebee; color: #d32f2f; }
        .room-default { background: #f5f5f5; color: #666; }
        
        .message {
            padding: 1rem; border-radius: 8px; margin-bottom: 1rem;
            font-weight: bold; text-align: center;
        }
        .message-success { background: #d4edda; color: #155724; }
        .message-error { background: #f8d7da; color: #721c24; }
        
        .empty-state {
            text-align: center; padding: 4rem; color: #7f8c8d;
        }
        .empty-state h3 { font-size: 2rem; margin-bottom: 1rem; }
        
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .boxes-grid { grid-template-columns: 1fr; }
            .actions { grid-template-columns: 1fr; }
            .google-setup input { width: 90%; }
        }
        
        .loading { display: none; }
        .loading.show { display: block; text-align: center; padding: 2rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏠 מעקב קרטונים למעבר דירה</h1>
            <p>ארגן את המעבר שלך בקלות עם סנכרון אוטומטי ל-Google Sheets</p>
        </div>
        
        <div id="status" class="status-bar status-local">
            📱 עובד במצב מקומי - הנתונים נשמרים במכשיר זה בלבד
        </div>
        
        <div class="main-content">
            <!-- Google Sheets Setup -->
            <div id="googleSetup" class="google-setup">
                <h3>🔗 חיבור ל-Google Sheets לשיתוף עם ויקה</h3>
                <p>צור Google Sheets חדש, שתף אותו עם ויקה והכנס כאן את הקישור</p>
                <input type="url" id="sheetsUrl" placeholder="https://docs.google.com/spreadsheets/d/...">
                <br>
                <button onclick="connectToSheets()">🚀 התחבר ל-Google Sheets</button>
                <button onclick="disconnectSheets()" style="background: #e74c3c; color: white;">❌ התנתק</button>
            </div>
            
            <div id="message"></div>
            
            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalBoxes">0</div>
                    <div class="stat-label">סה״כ קרטונים</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRooms">0</div>
                    <div class="stat-label">חדרים שונים</div>
                </div>
                <div class="stat-card">
                    <button class="btn btn-warning" onclick="exportToCSV()" style="width: 100%; margin-top: 10px;">
                        📥 הורד CSV
                    </button>
                    <div class="stat-label" style="margin-top: 10px;">ייצוא נתונים</div>
                </div>
            </div>
            
            <!-- Add Box Form -->
            <div class="card">
                <h3>➕ הוסף קרטון חדש</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>מספר קרטון:</label>
                        <input type="text" id="boxNumber" placeholder="לדוגמה: 1, A1, וכו'">
                    </div>
                    <div class="form-group">
                        <label>חדר יעד:</label>
                        <select id="boxRoom">
                            <option value="">בחר חדר</option>
                            <option value="סלון">סלון</option>
                            <option value="מטבח">מטבח</option>
                            <option value="החדר של אריאל">החדר של אריאל</option>
                            <option value="החדר של לירי">החדר של לירי</option>
                            <option value="החדר של ארז">החדר של ארז</option>
                            <option value="חדר מוזיקה">חדר מוזיקה</option>
                            <option value="החדר של ויקה ועמיחי">החדר של ויקה ועמיחי</option>
                            <option value="אמבטיה">אמבטיה</option>
                            <option value="שירותים">שירותים</option>
                            <option value="מחסן">מחסן</option>
                            <option value="מרפסת">מרפסת</option>
                            <option value="כלבו">כלבו</option>
                            <option value="אחר">אחר</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>תכולה:</label>
                        <input type="text" id="boxContents" placeholder="תאר את התכולה...">
                    </div>
                </div>
                <button class="btn btn-success" onclick="addBox()">➕ הוסף קרטון</button>
            </div>
            
            <!-- Loading -->
            <div id="loading" class="loading">
                <h3>🔄 מסנכרן עם Google Sheets...</h3>
            </div>
            
            <!-- Boxes List -->
            <div id="boxesList"></div>
        </div>
    </div>

    <script>
        // Global variables
        let boxes = [];
        let sheetsUrl = '';
        let isConnected = false;
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadLocalData();
            checkGoogleConnection();
            renderBoxes();
            updateStats();
        });
        
        // Load data from localStorage
        function loadLocalData() {
            try {
                const savedBoxes = localStorage.getItem('movingBoxes');
                if (savedBoxes) {
                    boxes = JSON.parse(savedBoxes);
                }
                
                const savedUrl = localStorage.getItem('sheetsUrl');
                if (savedUrl) {
                    sheetsUrl = savedUrl;
                    document.getElementById('sheetsUrl').value = savedUrl;
                }
            } catch (error) {
                console.error('Error loading data:', error);
                boxes = [];
            }
        }
        
        // Save data to localStorage
        function saveLocalData() {
            try {
                localStorage.setItem('movingBoxes', JSON.stringify(boxes));
                if (sheetsUrl) {
                    localStorage.setItem('sheetsUrl', sheetsUrl);
                }
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }
        
        // Check Google Sheets connection
        function checkGoogleConnection() {
            if (sheetsUrl) {
                const sheetsId = extractSheetsId(sheetsUrl);
                if (sheetsId) {
                    updateStatus('connected', '🔗 מחובר ל-Google Sheets - הנתונים מסונכרנים אוטומטית');
                    isConnected = true;
                    hideGoogleSetup();
                    loadFromSheets();
                }
            }
        }
        
        // Connect to Google Sheets
        function connectToSheets() {
            const url = document.getElementById('sheetsUrl').value.trim();
            
            if (!url) {
                showMessage('אנא הכנס קישור Google Sheets', 'error');
                return;
            }
            
            if (!url.includes('docs.google.com/spreadsheets')) {
                showMessage('קישור לא תקין - וודא שזה קישור ל-Google Sheets', 'error');
                return;
            }
            
            const sheetsId = extractSheetsId(url);
            if (!sheetsId) {
                showMessage('לא הצלחתי לחלץ מזהה מהקישור', 'error');
                return;
            }
            
            sheetsUrl = url;
            saveLocalData();
            
            // Test connection
            testSheetsConnection(sheetsId);
        }
        
        // Extract Sheets ID from URL
        function extractSheetsId(url) {
            const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            return match ? match[1] : null;
        }
        
        // Test Sheets connection
        function testSheetsConnection(sheetsId) {
            showLoading(true);
            
            // Test if we can access the sheet via CSV export
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetsId}/export?format=csv&gid=0`;
            
            fetch(csvUrl, { mode: 'no-cors' })
                .then(() => {
                    isConnected = true;
                    updateStatus('connected', '🔗 התחברות הצליחה! מסנכרן נתונים...');
                    hideGoogleSetup();
                    setupSheets(sheetsId);
                    showMessage('התחברות ל-Google Sheets הצליחה! 🎉', 'success');
                })
                .catch(error => {
                    console.error('Connection test failed:', error);
                    updateStatus('error', '❌ שגיאה בחיבור - וודא שהגיליון משותף לכולם');
                    showMessage('שגיאה בחיבור - וודא שהגיליון זמין לכולם', 'error');
                })
                .finally(() => {
                    showLoading(false);
                });
        }
        
        // Setup Sheets with initial data
        function setupSheets(sheetsId) {
            if (boxes.length > 0) {
                // We have local data, sync it to sheets
                syncToSheets();
            } else {
                // Try to load from sheets
                loadFromSheets();
            }
        }
        
        // Load data from Google Sheets
        function loadFromSheets() {
            if (!isConnected || !sheetsUrl) return;
            
            const sheetsId = extractSheetsId(sheetsUrl);
            if (!sheetsId) return;
            
            showLoading(true);
            
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetsId}/export?format=csv&gid=0`;
            
            // Use a proxy service for CORS
            const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(csvUrl);
            
            fetch(proxyUrl)
                .then(response => response.json())
                .then(data => {
                    const csvData = data.contents;
                    if (csvData && csvData.includes('מספר קרטון')) {
                        const loadedBoxes = parseCSVData(csvData);
                        if (loadedBoxes.length > 0) {
                            boxes = loadedBoxes;
                            saveLocalData();
                            renderBoxes();
                            updateStats();
                            showMessage(`נטענו ${loadedBoxes.length} קרטונים מ-Google Sheets! 📊`, 'success');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading from sheets:', error);
                    showMessage('לא הצלחתי לטעון מ-Google Sheets, משתמש בנתונים מקומיים', 'error');
                })
                .finally(() => {
                    showLoading(false);
                });
        }
        
        // Parse CSV data
        function parseCSVData(csvData) {
            const lines = csvData.split('\n');
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const columns = parseCSVLine(line);
                    if (columns.length >= 3 && columns[0] && columns[1] && columns[2]) {
                        result.push({
                            id: Date.now() + i,
                            number: columns[0].replace(/"/g, ''),
                            contents: columns[1].replace(/"/g, ''),
                            room: columns[2].replace(/"/g, ''),
                            timestamp: columns[3] ? columns[3].replace(/"/g, '') : new Date().toLocaleString('he-IL')
                        });
                    }
                }
            }
            
            return result;
        }
        
        // Parse CSV line
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }
        
        // Sync to Google Sheets
        function syncToSheets() {
            if (!isConnected || !sheetsUrl || boxes.length === 0) return;
            
            // For now, just show instructions since direct API access requires auth
            showMessage('נתונים מוכנים לסנכרון! פתח את Google Sheets והעתק את הנתונים מהקובץ CSV שהורדת', 'success');
        }
        
        // Add new box
        function addBox() {
            const number = document.getElementById('boxNumber').value.trim();
            const contents = document.getElementById('boxContents').value.trim();
            const room = document.getElementById('boxRoom').value;
            
            if (!number || !contents || !room) {
                showMessage('אנא מלא את כל השדות', 'error');
                return;
            }
            
            // Check if box number exists
            if (boxes.some(box => box.number === number)) {
                showMessage('מספר קרטון כבר קיים!', 'error');
                return;
            }
            
            const newBox = {
                id: Date.now(),
                number: number,
                contents: contents,
                room: room,
                timestamp: new Date().toLocaleString('he-IL')
            };
            
            boxes.push(newBox);
            saveLocalData();
            
            // Clear form
            document.getElementById('boxNumber').value = '';
            document.getElementById('boxContents').value = '';
            document.getElementById('boxRoom').value = '';
            
            renderBoxes();
            updateStats();
            
            if (isConnected) {
                syncToSheets();
            }
            
            showMessage('קרטון נוסף בהצלחה! 🎉', 'success');
        }
        
        // Delete box
        function deleteBox(id) {
            if (confirm('האם אתה בטוח שברצונך למחוק קרטון זה?')) {
                boxes = boxes.filter(box => box.id !== id);
                saveLocalData();
                renderBoxes();
                updateStats();
                
                if (isConnected) {
                    syncToSheets();
                }
                
                showMessage('קרטון נמחק בהצלחה!', 'success');
            }
        }
        
        // Export to CSV
        function exportToCSV() {
            if (boxes.length === 0) {
                showMessage('אין קרטונים לייצא', 'error');
                return;
            }
            
            const headers = ['מספר קרטון', 'תכולה', 'חדר יעד', 'תאריך הוספה'];
            const csvContent = [
                headers.join(','),
                ...boxes.map(box => [
                    `"${box.number}"`,
                    `"${box.contents}"`,
                    `"${box.room}"`,
                    `"${box.timestamp}"`
                ].join(','))
            ].join('\n');
            
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `קרטונים_מעבר_דירה_${new Date().toLocaleDateString('he-IL').replace(/\./g, '_')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('קובץ CSV הורד בהצלחה! 📁', 'success');
        }
        
        // Disconnect from Sheets
        function disconnectSheets() {
            sheetsUrl = '';
            isConnected = false;
            localStorage.removeItem('sheetsUrl');
            document.getElementById('sheetsUrl').value = '';
            updateStatus('local', '📱 עובד במצב מקומי - הנתונים נשמרים במכשיר זה בלבד');
            showGoogleSetup();
            showMessage('התנתקת מ-Google Sheets', 'success');
        }
        
        // Render boxes
        function renderBoxes() {
            const container = document.getElementById('boxesList');
            
            if (boxes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>📦 עדיין אין קרטונים</h3>
                        <p>התחל להוסיף קרטונים כדי לארגן את המעבר שלך</p>
                    </div>
                `;
                return;
            }
            
            // Group by rooms
            const groupedBoxes = {};
            boxes.forEach(box => {
                if (!groupedBoxes[box.room]) {
                    groupedBoxes[box.room] = [];
                }
                groupedBoxes[box.room].push(box);
            });
            
            let html = '';
            Object.keys(groupedBoxes).forEach(room => {
                html += `
                    <div class="card">
                        <h3>🏠 ${room} (${groupedBoxes[room].length} קרטונים)</h3>
                        <div class="boxes-grid">
                `;
                
                groupedBoxes[room].forEach(box => {
                    const roomClass = getRoomClass(box.room);
                    html += `
                        <div class="box-card">
                            <div class="box-number">#${box.number}</div>
                            <div class="room-tag ${roomClass}">${box.room}</div>
                            <div class="contents-box">${box.contents}</div>
                            <div class="timestamp">נוסף: ${box.timestamp}</div>
                            <div class="actions">
                                <button class="btn btn-danger" onclick="deleteBox(${box.id})">🗑️ מחק</button>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Get room CSS class
        function getRoomClass(room) {
            const classes = {
                'סלון': 'room-salon',
                'מטבח': 'room-kitchen',
                'החדר של אריאל': 'room-ariel',
                'החדר של לירי': 'room-liri',
                'החדר של ארז': 'room-erez',
                'חדר מוזיקה': 'room-music',
                'החדר של ויקה ועמיחי': 'room-vika'
            };
            return classes[room] || 'room-default';
        }
        
        // Update statistics
        function updateStats() {
            document.getElementById('totalBoxes').textContent = boxes.length;
            
            const rooms = new Set(boxes.map(box => box.room));
            document.getElementById('totalRooms').textContent = rooms.size;
        }
        
        // Update status bar
        function updateStatus(type, message) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status-bar status-${type}`;
            statusEl.textContent = message;
        }
        
        // Show/hide Google setup
        function hideGoogleSetup() {
            document.getElementById('googleSetup').style.display = 'none';
        }
        
        function showGoogleSetup() {
            document.getElementById('googleSetup').style.display = 'block';
        }
        
        // Show loading
        function showLoading(show) {
            const loadingEl = document.getElementById('loading');
            if (show) {
                loadingEl.classList.add('show');
            } else {
                loadingEl.classList.remove('show');
            }
        }
        
        // Show message
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.className = `message message-${type}`;
            messageEl.textContent = text;
            
            setTimeout(() => {
                messageEl.textContent = '';
                messageEl.className = '';
            }, 5000);
        }
        
        // Enter key support
